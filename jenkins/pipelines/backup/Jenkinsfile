pipeline {
    agent any // Rulează pe orice agent disponibil

    environment {
        DOCKERHUB_CREDENTIALS = 'dockerhub-credentials-id' // ID-ul credențialelor Jenkins
        DOCKERHUB_USERNAME = 'utilizatorulvostru' // Numele de utilizator Docker Hub
        IMAGE_NAME = "backup-app"
    }

    stages {
        stage('Checkout') {
            steps {
                // Clonează codul din Git (presupunând că Jenkinsfile este în repo)
                git 'https://github.com/vostru/repo.git' // Înlocuiți cu URL-ul repo-ului
            }
        }

        stage('Lint (Verificare Sintaxă)') {
            steps {
                // Rulăm într-un container Python pentru a avea un mediu curat
                docker.image('python:3.10-slim').inside {
                    sh 'pip install flake8'
                    // Verificăm stilul și sintaxa la noua cale
                    sh 'flake8 scripts/backup.py' 
                }
            }
        }

        stage('Test (Unit Tests)') {
            steps {
                // Aici ar rula testele unitare, dacă ar exista
                echo "Etapa de Teste (de implementat) - Trecem peste"
                sh 'echo "Testele ar rula aici"'
            }
        }

        stage('Build Docker Image') {
            steps {
                // Construim imaginea folosind noul context și calea Dockerfile
                script {
                    // Contextul este '.', Dockerfile este specificat cu '-f'
                    def appImage = docker.build("${env.DOCKERHUB_USERNAME}/${env.IMAGE_NAME}:${env.BUILD_NUMBER}", "-f docker/backup/Dockerfile .")
                    // Salvează imaginea pentru etapa următoare
                    appImage.push("latest")
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                // Folosim credențialele Jenkins pentru a ne autentifica
                docker.withRegistry("https://index.docker.io/v1/", DOCKERHUB_CREDENTIALS) {
                    // Publicăm ambele tag-uri
                    sh "docker push ${env.DOCKERHUB_USERNAME}/${env.IMAGE_NAME}:${env.BUILD_NUMBER}"
                    sh "docker push ${env.DOCKERHUB_USERNAME}/${env.IMAGE_NAME}:latest"
                }
            }
        }

        stage('Cleanup') {
            // Ștergem imaginea locală după push
            steps {
                sh "docker rmi ${env.DOCKERHUB_USERNAME}/${env.IMAGE_NAME}:${env.BUILD_NUMBER}"
                sh "docker rmi ${env.DOCKERHUB_USERNAME}/${env.IMAGE_NAME}:latest"
            }
        }
    }
}