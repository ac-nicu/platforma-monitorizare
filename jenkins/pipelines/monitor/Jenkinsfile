pipeline {
    agent any

    environment {
        DOCKERHUB_CREDENTIALS = 'dockerhub-credentials-id' // Același ID ca mai sus
        DOCKERHUB_USERNAME = 'utilizatorulvostru'
        IMAGE_NAME = "monitor-app"
        DEPLOY_SERVER = 'ssh-server-id' // ID credențiale SSH pentru serverul Ansible/VM
    }

    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/vostru/repo.git'
            }
        }

        stage('Lint (ShellCheck)') {
            steps {
                // Folosim o imagine care are shellcheck preinstalat
                docker.image('koalaman/shellcheck:stable').inside {
                    // Verificăm scriptul de monitorizare la noua cale
                    sh 'shellcheck scripts/monitor.sh'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    // Contextul este '.', Dockerfile este specificat cu '-f'
                    def appImage = docker.build("${env.DOCKERHUB_USERNAME}/${env.IMAGE_NAME}:${env.BUILD_NUMBER}", "-f docker/monitor/Dockerfile .")
                    appImage.push("latest")
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                docker.withRegistry("https://index.docker.io/v1/", DOCKERHUB_CREDENTIALS) {
                    sh "docker push ${env.DOCKERHUB_USERNAME}/${env.IMAGE_NAME}:${env.BUILD_NUMBER}"
                    sh "docker push ${env.DOCKERHUB_USERNAME}/${env.IMAGE_NAME}:latest"
                }
            }
        }

        stage('Deploy (cu Ansible)') {
            steps {
                // Această etapă ar rula playbook-ul Ansible
                // Presupune că agentul Jenkins are Ansible și cheile SSH
                echo "Rulare playbook Ansible pentru deploy..."
                
                // Folosim credențialele SSH
                withCredentials([sshUserPrivateKey(credentialsId: env.DEPLOY_SERVER, keyFileVariable: 'SSH_KEY')]) {
                    sh """
                        # Adăugăm cheia la ssh-agent
                        ssh-agent-run
                        ssh-add \$SSH_KEY
                        
                        # Rulăm playbook-ul de deploy
                        # Căi actualizate pentru inventar și playbook
                        ansible-playbook -i ansible/inventory.ini ansible/playbooks/deploy_platform.yml
                    """
                }
            }
        }

        stage('Cleanup') {
            steps {
                sh "docker rmi ${env.DOCKERHUB_USERNAME}/${env.IMAGE_NAME}:${env.BUILD_NUMBER}"
                sh "docker rmi ${env.DOCKERHUB_USERNAME}/${env.IMAGE_NAME}:latest"
            }
        }
    }
}